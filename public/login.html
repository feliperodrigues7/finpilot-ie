<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FinPilot IE - Login</title>
  <link rel="icon" href="data:," />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <style>
    body{display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f0f2f5;margin:0}
    .card{background:#fff;padding:2rem;border-radius:.5rem;box-shadow:0 4px 6px rgba(0,0,0,.1);width:100%;max-width:400px}
  </style>
</head>
<body>
  <div class="card">
    <h1 class="text-2xl font-bold mb-6 text-center">FinPilot IE - Login</h1>
    <div id="login-form">
      <div class="mb-4">
        <label for="email" class="block text-gray-700 text-sm font-bold mb-2">E-mail:</label>
        <input type="email" id="email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" placeholder="seu@email.com" autocomplete="username">
      </div>
      <div class="mb-6">
        <label for="password" class="block text-gray-700 text-sm font-bold mb-2">Senha:</label>
        <input type="password" id="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" placeholder="••••••••" autocomplete="current-password">
      </div>
      <button id="login-button" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded w-full">Entrar</button>
      <p id="error-message" class="text-red-500 text-xs italic mt-4 text-center"></p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module">
    import { SUPABASE_URL, SUPABASE_ANON } from './config.js';

    const showErr = (msg) => { document.getElementById('error-message').textContent = msg || ''; };

    if (!window.supabase) {
      showErr('SDK do Supabase não carregou. Verifique sua conexão.');
    }

    const supa = window.supabase?.createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
    });

    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('login-button');

    async function handleLogin() {
      showErr('');
      const email = (emailInput.value || '').trim();
      const password = passwordInput.value || '';

      if (!email || !password) {
        showErr('Por favor, preencha e-mail e senha.');
        return;
      }
      if (!supa) {
        showErr('Cliente Supabase não inicializado.');
        return;
      }

      try {
        loginButton.disabled = true;
        loginButton.textContent = 'Entrando...';
        const { error } = await supa.auth.signInWithPassword({ email, password });
        if (error) {
          showErr(`Erro: ${error.message}`);
        } else {
          window.location.href = './finance.html';
        }
      } catch (err) {
        showErr(`Erro inesperado: ${err.message || err}`);
      } finally {
        loginButton.disabled = false;
        loginButton.textContent = 'Entrar';
      }
    }

    loginButton.addEventListener('click', handleLogin);
    [emailInput, passwordInput].forEach(el => el.addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); }));

    // Utilitário para limpeza total local
    function clearLocalAuth() {
      try {
        const keys = Object.keys(localStorage);
        keys.forEach(k => {
          if (k.startsWith('sb-') && k.endsWith('-auth-token')) localStorage.removeItem(k);
          if (k.startsWith('supabase.')) localStorage.removeItem(k);
        });
        sessionStorage.clear();
        console.log('[Login] Storage limpo.');
      } catch {}
    }

    // Checagem de sessão com comportamento mais "duro"
    const params = new URLSearchParams(location.search);
    const cameFromLogout = params.get('logout') === '1';

    (async () => {
      if (!supa) return;

      if (cameFromLogout) {
        // Garantir logout global + limpeza e permanecer na tela
        try { await supa.auth.signOut({ scope: 'global' }); } catch {}
        clearLocalAuth();
        console.log('[Login] Veio de logout: permanece na tela de login.');
        return;
      }

      // 1) Verificar sessão local
      const { data: { session }, error: sessErr } = await supa.auth.getSession();
      if (sessErr) {
        console.warn('[Login] Erro ao checar sessão:', sessErr.message);
        return;
      }
      if (!session) {
        console.log('[Login] Sem sessão local: permanece.');
        return;
      }

      // 2) Validar sessão no servidor (ponto crítico para evitar redireciono indevido)
      const { data: userData, error: userErr } = await supa.auth.getUser();
      if (userErr || !userData?.user) {
        console.log('[Login] Sessão inválida no servidor. Limpando e permanecendo.');
        try { await supa.auth.signOut({ scope: 'global' }); } catch {}
        clearLocalAuth();
        return;
      }

      // 3) Sessão confirmada no servidor → redireciona
      console.log('[Login] Sessão válida: redirecionando para finance.');
      window.location.href = './finance.html';
    })();
  </script>
</body>
</html>
